

## 项目概述

本项目提供一套 **Clash Verge（Rev）/ Stash** 的分流策略模版，仅仅改动代理，就能最全面的日常软件的分流。

本模版 已实现的分流规则：

- **分流 DNS查询**：
    - 非中国网站的DNS查询，全部走代理（首次查询直接走VPN代理，不会发起Fallback。 效果 = 无DNS泄漏 + 无DNS污染）
    - 中国网站，使用操作系统的内置查询路径
- **分流 NTP查询**：
- **分流 广告、偷窥隐私、反诈监控等流氓流量**：
- **分流 GFW 流量**：
- **分流 境外主流应用 流量**
    - 包括：境外游戏、视音频、社交、新闻、AI工具、下载站、网盘、交易所、支付、购物、测速、其他工具 等等，每个都支持独立配置
- **分流 境外强制住宅IP才能访问的流量**：
    - 如：当地银行
- **分流 回国流量**：
- **分流 IP归属地流量**： 
    - 只代理 显示IP归属地 所需的流量，但APP内的其他流量、如图片 视频 ，均不走代理
- **基于地理位置的兜底策略**：
    - 如果没有匹配到上述的 分流策略，根据目标网站地理位置，匹配最近地理位置的节点
- **抗节点失联**：
    - 如单一节点被GFW间歇性封锁，但又需要此节点的IP来访问网站，那么其他任意中转节点，都可以作为中间节点，链式代理 连接其他国家节点。从而最大限度保证了访问单一网站时IP的稳定性 （如果IP在不通国家之间跳来跳去，会被很多网站封控）
- **反代理识别软件的检测**：
    - 强制redir-host，避免因返回fakeip，而被软件检测识别出使用了代理。


.


## 配置描述

 - （最全） 01-WhiteList_模版.yaml
   - 规则9万多
   - 包含了全部分流策略，包括3万条反广告和4万条隐私保护

 - （建议） 04-WhiteList-Min.AntiAD_模版.yaml    
   - 规则1.2万多
   - 与上述比，仅保留了4000多条反广告（无隐私保护）

 - （精简） 05-WhiteList-Non.AntiAD_模版.yaml
   - 规则1.2万多
   - 与上述比，无任何反广告（无隐私保护）

.


## 默认启用的节点

- 美国中转节点
- 美国住宅节点
- 日本中转节点
- 英国中转节点
- 澳洲中转节点
- 归属地落地节点

.


## 分流策略总揽

总计九级分流

```yaml
   # ------------------------------------------------------------------------------------
   #  说明文档 ： 路由规则（Rule）  -  大纲！！！ 总计九级
   # ------------------------------------------------------------------------------------
   #      [第一级] 分流规则   :  前置规则（如局域网）     
   # ------------------------------------------------------------------------------------                    
   #      [第二级] 分流规则   :  APP、网站               
   # ------------------------------------------------------------------------------------                    
   #      [第三级] 分流规则   :  GFWList                  
   # ------------------------------------------------------------------------------------                    
   #      [第四级] 分流规则   :  回国（如CN）             
   # ------------------------------------------------------------------------------------                    
   #      [第五级] 分流规则   :  国际大厂                     
   # ------------------------------------------------------------------------------------                  
   #      [第六级] 分流规则   :  国家（根域名）           
   # ------------------------------------------------------------------------------------                   
   #      [第七级] 分流规则   :  国家（地理位置、GeoIP）  
   # ------------------------------------------------------------------------------------               
   #      [第八级] 分流规则   :  CDN                      
   # ------------------------------------------------------------------------------------
   #      [第九级] 分流规则   :  兜底策略 
   # ------------------------------------------------------------------------------------
```

.

## 九级分流策略详解（按如下顺序匹配）


```yaml
   #  说明文档 ： 路由规则（Rule）  -  明细
   # --------------------------------------------------------------------------------
   #           [第一级] 分流规则 : 前置 规则                    (仅域名匹配)
   # --------------------------------------------------------------------------------
   #
   # [1st-00] -  基础协议 
   # [1st-01] -  DNS \ NTP 
   # [1st-02] -  局域网 
   # [1st-03] -  自己的翻墙域名
   # [1st-04] -  功能补充
   # [1st-05] -  特定修复
   # [1st-05] -  屏蔽 “有害软件、有害网站”
   # [1st-08] -  保护隐私
   # [1st-09] -  屏蔽广告
   # [1st-09] -  VNP软件                      - [默认路由：直连]
   #
   # --------------------------------------------------------------------------------
   #         [第二级] 分流规则 : APP、网站                        (仅域名匹配)
   # --------------------------------------------------------------------------------
   #
   # [2st-00] -  测速
   #  
   # [2st-01] -  私有云：NAS    
   # [2st-02] -  公有云：云盘、云存储                  
   # [2st-04] -  P2P下载软件        
   # [2st-05] -  需加速 才能流畅访问的网站      
   #                    
   # [2st-10] -  专属网站    (默认路由：不可配置)
   # [2st-11] -  金融                
   # [2st-12] -  各国银行    (默认路由：不可配置)
   #                                                   
   # [2st-20] -  购物                 
   # [2st-21] -  游戏                 
   # [2st-22] -  视频                 
   # [2st-23] -  短视频               
   # [2st-24] -  直播                 
   # [2st-25] -  音频                 
   # [2st-26] -  社交                 
   # [2st-27] -  网络电话、eSIM        
   # [2st-28] -  资讯                 
   # [2st-29] -  AI                 
   # [2st-30] -  工具                 
   #                          
   # [2st-80] -  特定软件 (默认路由：不可配置)
   #
   # --------------------------------------------------------------------------------
   #       [第三级] 分流规则 :  （GFWList）                     (仅域名匹配)
   # --------------------------------------------------------------------------------
   # 
   # [3st-01] -  Gfwlist （注意，此阶段，一定要防止 “敏感域名” 的 “DNS泄露” ） 
   #
   # --------------------------------------------------------------------------------
   #       [第四级] 分流规则 :  使用者常驻国家                  (IP匹配 + DNS解析)
   # --------------------------------------------------------------------------------
   # 
   # [4st-01] -  IP归属地：视音频       
   # [2st-52] -  IP归属地：社交         
   # [2st-53] -  IP归属地：购物         
   #                       
   # [4st-02] -  回国：网盘、云盘、下载软件 
   # [4st-02] -  回国：视音频
   # [4st-02] -  回国：社交
   # [4st-02] -  回国：媒体
   # [4st-02] -  回国：购物
   # [4st-02] -  回国：游戏
   # [4st-02] -  回国：其他
   #                      
   # [4st-05] -  国家顶级域名（中国） 
   # [4st-05] -  GeoIP（中国）    
   #
   # --------------------------------------------------------------------------------
   #       [第五级] 分流规则 :  国际大厂                          (IP匹配 + DNS解析)
   # --------------------------------------------------------------------------------
   #  
   # [5st-01] -  国际大厂          
   #
   # --------------------------------------------------------------------------------
   #      [第六级] 分流规则 : 国家、洲际（顶级域名）          (仅域名匹配)
   # --------------------------------------------------------------------------------
   #
   # [6st-01] -  国家顶级域名（VPS所在国家）     
   # [6st-02] -  国家顶级域名（其他国家，按洲际分类）         
   #
   # --------------------------------------------------------------------------------
   #       [第七级] 分流规则 : 国家、洲际（GeoIP）            (IP匹配 + DNS解析) 
   # --------------------------------------------------------------------------------
   #       
   # [7st-01] -   GeoIP（VPS所在国家）           
   # [7st-02] -   GeoIP（全球，按洲际分类）        
   #
   # --------------------------------------------------------------------------------
   #       [第八级] 分流规则 : CDN                            (IP匹配 + DNS解析) 
   # --------------------------------------------------------------------------------
   #
   # [8st-01] -   CDN      
   #
   # --------------------------------------------------------------------------------
   #       [第九级] 分流规则 : 兜底 
   # --------------------------------------------------------------------------------
   #
   # [9st] -   Final 
   #
   # --------------------------------------------------------------------------------
```   

.


## 更详细的 分流选项


```yaml  
   # [1st-01] -  DNS \ NTP               
       '📡.<DNS>—HttpDNS'                                    
       '📡.<DNS>—GlobalDNS'                                  
       '📡.<DNS>—ChinaDNS'                                   
       '📡.<NTP>—GlobalNTP'                                  
       '📡.<NTP>—ChinaNTP'                                   

   # [1st-05] -  反劫持（Hijacking） 反私有DNS跟踪（HttpDNS）  
       '⛔️.<Protection>—Hijacking'                           

   # [1st-08]  [1st-09] -  隐私保护（Privacy） 屏蔽广告 
       '⛔️.<Protection>—Privacy'                             
       '⛔️.<Protection>—ADblock'                             
                           
  
   # [1st-02] -  局域网（Lan）         
       '💻.<Lan>'                                            

   # [2st-01] -  私有云：NAS           
       '💻.<NAS>—Synology'                                   
       '💻.<NAS>—QNAP'                                       

   # [2st-02] -  公有云：云盘、云存储                                
       '📂.<Drive>—iCloud'                                   
       '📂.<Drive>—OneDrive'                                 
       '📂.<Drive>—Dropbox'                                  
       '📂.<Drive>—GoogleDrive'                              
       '📂.<Drive>—MEGA'                                     
       '📂.<Drive>—Imgur'                                    
       '📂.<Drive>—InternetArchive'                          

   # [2st-04] -  被GFW阻挡的，其他下载站云盘                         
       '⬇️.<P2P>—PT-Server'                                   
       '⬇️.<P2P>—eMule-Server'                                

   # [2st-05] -  需加速 才能流畅访问的网站                           
       '⬇️.<Download>—MacAppUpgrade'                          

   # [2st-11] -  金 融                                               
       '💰.<Finance>—Paypal'                                 
       '💰.<Finance>—Wise'                                   
       '₿.<Crypto>—Binance'                                  
       '₿.<Crypto>—OKX'                                      
       '💳.<Virtual>—Monzo'                                  
       '💳.<Virtual>—Revolut'                                

  # [2st-12] -  各国银行                                             
       '🇺🇸.<Bank>—US'                                        
       '🇨🇦.<Bank>—CA'                                        
       '🇬🇧.<Bank>—UK'                                        
       '🇦🇺.<Bank>—AU'                                        
       '🇯🇵.<Bank>—JP'                                        

   # [2st-13] -  专属网站（必须要所属国IP才能正常下单的网站，银行除外
       '🇺🇸.<HomeIP>—US'                                      
   #   '🇨🇦.<HomeIP>—CA'                                      
   #   '🇬🇧.<HomeIP>—UK'                                      
   #   '🇦🇺.<HomeIP>—AU'                                      
       '🇯🇵.<HomeIP>—JP'                                      

   # [2st-14] - 不支持VPN的网站（除 银行、HomeIP 分流规则以外的 网站
       '❌.<UnsupportVPN>'                                   

   # [2st-20] -  购物                                                
       '🛒.<Shopping>—eBay'                                  
       '🛒.<Shopping>—Patreon'                               

   # [2st-21] -  游戏平台                                            
       '🕹️.<Game>—Xbox'                                      
       '🕹️.<Game>—PlayStation'                               
       '🕹️.<Game>—Nintendo'                                  
       '🕹️.<Game>—Steam'                                     
       '🕹️.<Game>—EPIC'                                      
       '🕹️.<Game>—GOG'                                       
       '🕹️.<Game>—RockStar'                                  
       '🕹️.<Game>—EA.Origin'                                 
       '🕹️.<Game>—UbiSoft'                                   

   # [2st-22] -  视频 软件                                           
       '📺.<Video>—YouTube'                                  
       '📺.<Video>—Netflix'                                  
       '📺.<Video>—PrimeVideo'                               
       '📺.<Video>—Disney'                                   
       '📺.<Video>—HBO'                                      
       '📺.<Video>—FOX'                                      
       '📺.<Video>—AppleTV'                                  
       '📺.<Video>—Porn'                                     

   # [2st-23] -  短视频                                              
       '🎬.<Short>—TikTok'                                   
       '🎬.<Short>—Instagram'                                
       '🎬.<Short>—Snapchat'                                 
       '🎬.<Short>—Triller'                                  

   # [2st-24] -  直播                                                
       '🎞️.<Live>—Twitch'                                    

   # [2st-25] -  音频                                                
       '🎧.<Audio>—Spotify'                                  
       '🎧.<Audio>—YouTubeMusic'                             
       '🎧.<Audio>—AppleMusic'                               

   # [2st-26] -  社交                                                
       '💛.<Social>—Facebook'                                
       '💛.<Social>—Twitter'                                 
       '💛.<Social>—Telegram'                                
       '💛.<Social>—Reddit'                                  
       '💛.<Social>—Whatsapp'                                
       '💛.<Social>—Line'                                    
       '💛.<Social>—Discord'                                 
       '💛.<Social>—LinkedIn'                                
       '💛.<Social>—Teams'                                   
       '💛.<Social>—Clubhouse'                               
       '💛.<Social>—Signal'                                  
       '💛.<Social>—Tumblr'                                  
       '💛.<Social>—Pixiv'                                   

   # [2st-28] -  资讯                                                
       '📰.<News>—Wikipedia'                                 
       '📰.<News>—AppleNews'                                 

   # [2st-29] -  AI                                                  
       '💡.<AI>—OpenAI'                                      
       '💡.<AI>—xAI'                                         
       '💡.<AI>—Gemini'                                      
       '💡.<AI>—Claude'                                      
       '💡.<AI>—Copilot'                                     
       '💡.<AI>—GlobalAI'                                    

   # [2st-30] -  工具                                                
       '🔧.<Tools>—Adobe'                                    
       '🔧.<Tools>—Github'                                   
       '🔧.<Tools>—Notion'                                   
       '🔧.<Tools>—Pinterest'                                
       '🔧.<Tools>—Bing/Edge'                                
       '🖥️.<Remote>—Rustdesk'                                
       '🖥️.<Remote>—Parsec'                                  

   # [5st-01] -  大厂                                                
       '☁️.<Apps>—Google'                                    
       '☁️.<Apps>—Microsoft'                                 
       '☁️.<Apps>—Apple'                                     
       '☁️.<Apps>—Amazon'                                    

   # [7st-01] -  CDM 
       '☁️.<CDN>—Cloudflare'                                 

   # [4st-01] -  修改IP归属地   
       '🇨🇳.<ShowIP>—BiliBili'                                
       '🇨🇳.<ShowIP>—抖音'                                    
       '🇨🇳.<ShowIP>—快手'                                    
       '🇨🇳.<ShowIP>—小红书'                                  
       '🇨🇳.<ShowIP>—西瓜'                                    
       '🇨🇳.<ShowIP>—微博'                                    
       '🇨🇳.<ShowIP>—知乎'                                    
       '🇨🇳.<ShowIP>—贴吧'                                    
       '🇨🇳.<ShowIP>—豆瓣'                                    
       '🇨🇳.<ShowIP>—闲鱼'                                    

   # [4st-02] -  回国 中国 - 网盘  视频  社交 媒体  购物 大厂    [ Default
       '🇨🇳.<ReturnCN>—Drive'                                 
       '🇨🇳.<ReturnCN>—Video'                                 
       '🇨🇳.<ReturnCN>—Social'                                
       '🇨🇳.<ReturnCN>—News'                                  
       '🇨🇳.<ReturnCN>—Shopping'                              
       '🇨🇳.<ReturnCN>—Other'                                 
       '🇨🇳.<ReturnCN>—Final'                                 

   #  回国 美国
       '🇺🇸.<ReturnUS>—Final'                                 

   #  按目标网站所在国家分流
       '🌎.<Region>—North.America'                           
       '🌎.<Region>—South.America'                           
       '🌍.<Region>—Europe'                                  
       '🌏.<Region>—Oceania'                                 
       '🌏.<Region>—East.Asia'                               
       '🌏.<Region>—West.Asia'                               
       '🌍.<Region>—Africa'     
            
   # 兜底                   
       'Final'   
           
```

.


## 关于在 苹果手机 iOS （Stash）上使用

要特别注意以下几点：

1. Stash for iOS/Mac 无法分流中国网站（Geostie:CN）的DNS查询（到中国DNS）.
    - 由于并不能在DNS的nameserver-policy:中支持Geostie:CN，所以导致了，非CN域名的中国网站需要走境外DNS查询，从而导致如京东养车等APP会返回海外IP。向开发者多次反馈后，开发者压根不回复 不响应 （不知道怎么想的） 。而Clash Verga rec客户端，不会有这个问题。

2. 多DNS查询，可能会导致iOS的VPN频繁崩溃.
    - 在iOS上，多DNS查询会导致内存爆炸（超过iOS的50MB限制），从而导致VPN崩溃。如果遇到这种情况，请删除一个DNS，只使用 1.1.1.1 。多DNS查询，会成倍增加内存使用。本模版使用了2个DNS 1.1.1.1 、8.8.8.8

3. 慢速VPS节点，可能会导致iOS的VPN频繁崩溃.
    - 在iOS上，如果你的VPS节点过于慢，可能也会导致DNS查询时，内存爆炸（超过iOS的50MB限制），从而导致VPN崩溃。如果遇到这种情况，请将DNS查询指定到更换更快的VPS（哪怕带宽低都不怕，只要速度响应快）。

4. 以下两个特性要谨慎使用，在移动端会对电池消耗和内存占用导致很大影响
    - tcp-concurrent            : false     （不建议ture，因为开启后会导致移动端费电、并且导致iOS内存占用增加30%，而且耗电严重）
    - interval                  :  900      （不建议太频繁进行 “心跳测试”，这里设置为 15分钟=900秒 测试一次，否则耗电严重）

5. 除了以上配置，如果想达到最大省电效果，请在Stash图形界面完成如下配置：
    - 设置 -> 网络设置 -> 启用混合网络 （❌关闭）
    - 设置 -> 网络设置 -> 并发连接  （❌关闭）    
    - 设置 -> 网络设置 -> 启用Fallback DNS （❌关闭）
    - 设置 -> 网络设置 -> 包含所有网络 （❌关闭）

.


## 关于 DNS策略

本模版的DNS策略 已按如下思路进行配置：

- 本模版的DNS请求，采用白名单制度，只有命中了的中国域名，才会使用操作系统内置的的DNS进行请求，其他域名的DNS请求，均通过VPS进行代理，并且在此过程中，不会通过系统内置的DNS请求功能向国内DNS发起请求。从而最大限度的避免DNS泄漏。并且也没有Fake IP，所有DNS请求，只请求一次，只返回1.1.1.1/8.8.8.8解析后的真实IP。并且全程（通过VPS代理DNS请求的全过程）只使用DOH（DNS over Https），通过境外VPS，加密访问DNS。
  
- 本模版，通过上述方法，做到完美的保护隐私，以防止防火墙通过DNS请求窥探用户都去了哪些网站。
  
- 唯一的代价就是，要求VPS必须要快，如果在中国大陆使用，建议使用日本CN2/9929线路的VPS。本配置会通过每60秒一次的全自动ping，选取延迟最的VPS代理DNS请求。

.

## 其他

请不要使用任何，国产安卓、鸿蒙系统、运营商路由器的非桥接模式，进行 翻墙：

- 所有国产系统都内置了反诈插件，会直接导致你的翻墙被实时监控。


.


## 效果

<img width="477" alt="最终效果" src="https://github.com/user-attachments/assets/eb5704bc-450a-400f-b6f8-2e1ee0f3f40c" />



.


## 后记


由于clash所支持的yaml缺乏更强大额对象封装写法 （或 内连展开写法、预处理写法） ，使得无法做到，删减节点不影响代码主体。未来一旦支持这种特性。将会再次改动本脚本。 

.





## 许可与声明
- 本代码使用MIT协议分发
- 参与编写：OpenAI Chatgpt 5-pro Agent


